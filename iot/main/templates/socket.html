{% extends "base.html" %} 
{% load static %}

{% block content %}
    <div class="container">
        <h2>Управление солнечными установками</h2>
        <textarea id="memo" readonly placeholder="Здесь будет информация.."></textarea>
        <button id="getClients">Получить список клиентов</button>
        <div class="client-list" id="clientList"></div> <!-- Контейнер для списка клиентов с чекбоксами -->
    <div id="valueInputContainer" style="display: none;">
        <input type="number" id="valueInput" placeholder="Введите значение">
        <button id="sendValue">Отправить</button>
        <button id="cancelValue">Назад</button>
    </div>
        <div id="response"></div>
        
    <div class="control-buttons">
        <button class="control-button" id="btnUp">Up</button>
        <button class="control-button" id="btnDown">Down</button>
        <button class="control-button" id="btnLeft">Left</button>
        <button class="control-button" id="btnRight">Right</button>
        <button class="control-button" id="btnReset">Reset</button>
    </div>
    </div>

    

    <script>
    var currentCommand = '';
    $('.control-button').click(function() {
    var command = $(this).text().toLowerCase();
    currentCommand = command;
    if (command === 'up' || command === 'down' || command === 'left' || command === 'right') {
        $('#valueInputContainer').show();
    } else if (command === 'reset') {
        sendMessageToClient(command);
    }
});

$('#sendValue').click(function() {
    var value = $('#valueInput').val();
    sendMessageToClient(currentCommand + " " + value);
    $('#valueInputContainer').hide();
    $('#valueInput').val(''); // Очистка поля после отправки
});

    $('#cancelValue').click(function() {
    $('#valueInputContainer').hide();
    $('#valueInput').val(''); // Очистка поля при отмене
});

        
function appendToMemo(text) {
    var $memo = $("#memo");
    $memo.val($memo.val() + text + "\n"); // Добавляем текст с новой строки
    $memo.scrollTop($memo[0].scrollHeight); // Прокручиваем вниз до последнего сообщения
}

function populateClientsList(clientsObj) {
    var $clientList = $('#clientList');
    $clientList.empty(); // Очищаем список, если в нем уже что-то есть

    Object.entries(clientsObj).forEach(function([clientId, clientDetails]) {
        var $item = $('<div class="client-list-item">');
        var $button = $('<button class="client-button">').text(clientId).click(function() {
            // При нажатии кнопки устанавливаем активного клиента
            setActiveClient(clientId);
        });
        $item.append($button);
        $clientList.append($item);
    });
}

$("#getClients").click(function() {
    $.ajax({
        url: '/get_clients/',
        type: 'GET',
        success: function(response) {
            var clients;
            try {
                clients = typeof response === 'string' ? JSON.parse(response) : response;
            } catch (error) {
                console.error("Ошибка при разборе ответа сервера:", error);
                appendToMemo("Ошибка при разборе ответа сервера: " + error.message);
                return;
            }
            
            if(typeof clients === 'object' && clients !== null) {
                populateClientsList(clients); // Добавляем клиентов в список
                var formattedResponse = JSON.stringify(clients, null, 4);
            } else {
                console.error("Ответ сервера не является объектом:", clients);
                appendToMemo("Ответ сервера не является объектом: " + JSON.stringify(clients));
            }
        },
        error: function() {
            appendToMemo("Ошибка при получении списка клиентов");
        }
    });
});

function setActiveClient(clientId) {    
    $.ajax({
        url: '/set_active_client/',
        type: 'POST',
        data: { "client_id": clientId },
        success: function(response) {
            appendToMemo("Активный клиент установлен: " + clientId);
        },
        error: function() {
            appendToMemo("Ошибка при установке активного клиента");
        }
    });
}

function sendMessageToClient(message) {
    $.ajax({
        url: '/send_message/',
        type: 'POST',
        data: { "message": message },
        success: function(response) {
            appendToMemo("Сообщение отправлено: " + message);
        },
        error: function() {
            appendToMemo("Ошибка при отправке сообщения");
        }
    });
}

$("#sendMessage").click(function() {
        var message = $("#message").val();
        $.ajax({
                url: '/send_message/',
                type: 'POST',
                data: { "message": message },
                success: function(response) {
                    appendToMemo(response.message); // Выводим в Memo
                },
                error: function() {
                    appendToMemo("Ошибка при отправке сообщения");
                }
            });
        });
    </script>
{% endblock %}
